<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë‚˜ì´íŠ¸ íˆ¬ì–´ í¼ì¦</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #f0f0f0;
      padding: 30px;
    }

    h1 {
      margin-bottom: 5px;
    }

    #successCount, #timer {
      font-size: 18px;
      margin-bottom: 15px;
      color: #444;
    }

    .board {
      display: grid;
      gap: 4px;
      justify-content: center;
      margin-top: 10px;
    }

    .cell {
      background-color: white;
      border: 1px solid #333;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      cursor: pointer;
      user-select: none;
      width: 60px;
      height: 60px;
    }

    .visited {
      background-color: #d0e0ff;
    }

    .knight {
      font-size: 28px;
    }

    #message {
      margin-top: 20px;
      font-size: 18px;
      color: green;
    }

    .menu {
      margin-top: 30px;
    }

    .menu button, #clearRankingBtn, #resetBtn {
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
      cursor: pointer;
    }

    #resetBtn {
      display: none;
    }

    #ranking {
      text-align: left;
      margin: 20px auto;
      width: max-content;
    }

    #rankingList {
      padding-left: 20px;
      margin: 0;
    }
  </style>
</head>
<body>

<h1>â™ ë‚˜ì´íŠ¸ íˆ¬ì–´ í¼ì¦</h1>
<div id="successCount">ì„±ê³µ: 0</div>
<div id="timer">ì‹œê°„: 0.00ì´ˆ</div>
<div id="ranking">
  <h2>ğŸ† ë­í‚¹</h2>
  <ol id="rankingList"></ol>
  <button id="clearRankingBtn">ë­í‚¹ ì´ˆê¸°í™”</button>
</div>

<div id="menu" class="menu">
  <p>ë³´ë“œ í¬ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš”:</p>
  <button onclick="startGame(5)">5x5</button>
  <button onclick="startGame(6)">6x6</button>
  <button onclick="startGame(7)">7x7</button>
</div>

<div class="board" id="board"></div>
<div id="message"></div>
<button id="resetBtn" onclick="resetGame()">ë‹¤ì‹œ ì‹œì‘</button>

<script>
  let boardSize = 5;
  const board = document.getElementById('board');
  const message = document.getElementById('message');
  const resetBtn = document.getElementById('resetBtn');
  const menu = document.getElementById('menu');
  const successDisplay = document.getElementById('successCount');
  const timerDisplay = document.getElementById('timer');

  let knightPos = null;
  let visited = [];
  let successCount = 0;
  let gameEnded = false;

  let startTime = null;
  let timerInterval = null;

  window.onload = displayRanking;

  function startGame(size) {
    boardSize = size;
    menu.style.display = 'none';
    resetBtn.style.display = 'inline-block';
    createBoard();
    displayRanking();
  }

  function createBoard() {
    board.innerHTML = '';
    visited = [];
    knightPos = null;
    gameEnded = false;

    clearInterval(timerInterval);
    startTime = null;
    timerDisplay.textContent = 'ì‹œê°„: 0.00ì´ˆ';

    board.style.gridTemplateColumns = `repeat(${boardSize}, 60px)`;
    board.style.gridTemplateRows = `repeat(${boardSize}, 60px)`;

    for (let y = 0; y < boardSize; y++) {
      for (let x = 0; x < boardSize; x++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.x = x;
        cell.dataset.y = y;
        cell.addEventListener('click', handleClick);
        board.appendChild(cell);
      }
    }
    message.textContent = 'ì‹œì‘í•  ì¹¸ì„ ì„ íƒí•˜ì„¸ìš”.';
  }

  function handleClick(e) {
    if (gameEnded) return;

    const x = parseInt(e.target.dataset.x);
    const y = parseInt(e.target.dataset.y);
    const idx = y * boardSize + x;

    if (!knightPos) {
      knightPos = { x, y };
      visited.push(idx);
      startTime = Date.now();
      timerInterval = setInterval(() => {
        const elapsed = (Date.now() - startTime) / 1000;
        timerDisplay.textContent = `ì‹œê°„: ${elapsed.toFixed(2)}ì´ˆ`;
      }, 100);

      updateBoard();
      message.textContent = 'ì´ì œ ë‚˜ì´íŠ¸ì˜ ì´ë™ìœ¼ë¡œ ì§„í–‰í•˜ì„¸ìš”!';
      return;
    }

    const isValid = isValidKnightMove(knightPos, { x, y });
    const alreadyVisited = visited.includes(idx);

    if (isValid && !alreadyVisited) {
      knightPos = { x, y };
      visited.push(idx);
      updateBoard();

      if (visited.length === boardSize * boardSize) {
        clearInterval(timerInterval);
        const elapsed = Date.now() - startTime;
        message.textContent = 'ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ëª¨ë“  ì¹¸ì„ ë°©ë¬¸í–ˆìŠµë‹ˆë‹¤!';
        successCount++;
        updateSuccessCount();
        gameEnded = true;
        saveScore(elapsed);
      } else {
        checkIfStuck();
      }
    } else {
      message.textContent = alreadyVisited
        ? 'ì´ë¯¸ ë°©ë¬¸í•œ ì¹¸ì…ë‹ˆë‹¤.'
        : 'ë‚˜ì´íŠ¸ì˜ ì´ë™ ë°©ì‹ì´ ì•„ë‹™ë‹ˆë‹¤!';
    }
  }

  function isValidKnightMove(from, to) {
    const dx = Math.abs(from.x - to.x);
    const dy = Math.abs(from.y - to.y);
    return (dx === 2 && dy === 1) || (dx === 1 && dy === 2);
  }

  function getPossibleMoves(pos) {
    const directions = [
      { dx: 2, dy: 1 }, { dx: 1, dy: 2 },
      { dx: -1, dy: 2 }, { dx: -2, dy: 1 },
      { dx: -2, dy: -1 }, { dx: -1, dy: -2 },
      { dx: 1, dy: -2 }, { dx: 2, dy: -1 },
    ];

    return directions
      .map(d => ({ x: pos.x + d.dx, y: pos.y + d.dy }))
      .filter(p =>
        p.x >= 0 && p.x < boardSize &&
        p.y >= 0 && p.y < boardSize &&
        !visited.includes(p.y * boardSize + p.x)
      );
  }

  function checkIfStuck() {
    const moves = getPossibleMoves(knightPos);
    if (moves.length === 0) {
      clearInterval(timerInterval);
      message.textContent = 'ğŸ˜¢ ì´ë™í•  ìˆ˜ ìˆëŠ” ì¹¸ì´ ì—†ìŠµë‹ˆë‹¤. ì‹¤íŒ¨!';
      gameEnded = true;
    }
  }

  function updateBoard() {
    const cells = document.querySelectorAll('.cell');
    cells.forEach((cell, index) => {
      cell.classList.remove('knight', 'visited');
      cell.textContent = '';
      if (visited.includes(index)) {
        cell.classList.add('visited');
      }
    });

    if (knightPos) {
      const knightIdx = knightPos.y * boardSize + knightPos.x;
      const knightCell = cells[knightIdx];
      knightCell.textContent = 'â™';
      knightCell.classList.add('knight');
    }
  }

  function updateSuccessCount() {
    successDisplay.textContent = `ì„±ê³µ: ${successCount}`;
  }

  function resetGame() {
    clearInterval(timerInterval);
    menu.style.display = 'block';
    resetBtn.style.display = 'none';
    board.innerHTML = '';
    message.textContent = '';
    gameEnded = false;
    timerDisplay.textContent = 'ì‹œê°„: 0.00ì´ˆ';
    displayRanking();
  }

  function saveScore(elapsed) {
    const name = prompt('ì„±ê³µí–ˆìŠµë‹ˆë‹¤! ë­í‚¹ì— ë“±ë¡í•  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', '');
    const playerName = name ? name : 'ìµëª…';
    const highScores = JSON.parse(localStorage.getItem('knightTourHighScores')) || [];
    highScores.push({ name: playerName, time: elapsed });
    highScores.sort((a, b) => a.time - b.time);
    if (highScores.length > 5) highScores.splice(5);
    localStorage.setItem('knightTourHighScores', JSON.stringify(highScores));
    displayRanking();
  }

  function displayRanking() {
    const highScores = JSON.parse(localStorage.getItem('knightTourHighScores')) || [];
    const rankingList = document.getElementById('rankingList');
    rankingList.innerHTML = '';
    highScores.forEach(score => {
      const li = document.createElement('li');
      li.textContent = `${score.name}: ${(score.time/1000).toFixed(2)}ì´ˆ`;
      rankingList.appendChild(li);
    });
  }

  document.getElementById('clearRankingBtn').addEventListener('click', () => {
    const pwd = prompt('ë­í‚¹ì„ ì´ˆê¸°í™”í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
    if (pwd === 'chayejun') {
      localStorage.removeItem('knightTourHighScores');
      alert('ë­í‚¹ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      displayRanking();
    } else {
      alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
    }
  });
</script>

</body>
</html>
